<!-- 重点：clusterMarkerAdd clusterMarkerRemove -->
<!doctype html>
<html lang="zh-CN">

	<head>
		<!-- 原始地址：//webapi.amap.com/ui/1.1/ui/geo/DistrictCluster/examples/food-tour.html -->
		<base href="//webapi.amap.com/ui/1.1/ui/geo/DistrictCluster/examples/" />
		<meta charset="utf-8">
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
		<title>各地美食</title>
		<style>
			html,
			body,

			#container {
				width: 100%;
				height: 100%;
				margin: 0px;
			}

			#loadingTip {
				position: absolute;
				z-index: 9999;
				top: 0;
				left: 0;
				padding: 3px 10px;
				background: red;
				color: #fff;
				font-size: 14px;
			}

			.poi-img {
				width: 30px;
				height: 30px;
				background-position: 50% 50%;
				position: absolute;
				border: 1px solid #8e8e8e;
				border-radius: 15px;
			}

			.poi-img:before,
			.poi-img:after {
				content: '';
				display: block;
				position: absolute;
				width: 0;
				height: 0;
				border: solid rgba(0, 0, 0, 0);
				border-width: 6px 6px;
				top: -12px;
				left: 9px;
				border-bottom-color: #505050;
			}

			.poi-img:before {
				top: -13px;
				border-bottom-color: #8e8e8e;
			}
		</style>
	</head>

	<body>
		<div id="container"></div>
		<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
		<script type="text/javascript" src='//webapi.amap.com/maps?v=2.0&key=ca239aaba535516ef35f38cdca63250f'></script>
		<!-- UI组件库 1.0 -->
		<script src="//webapi.amap.com/ui/1.1/main.js?v=1.1.1"></script>
		<script type="text/javascript">
			//创建地图
			var map = new AMap.Map('container', {
				zoom: 4,
				center: [108.928214, 34.539385]
			});

			function initPage(DistrictCluster, $, SimpleInfoWindow) {

				var distCluster = new DistrictCluster({
					map: map, //所属的地图实例
					zIndex: 11,
					getPosition: function(item) {

						if (!item) {
							return null;
						}

						var parts = item.split(',');

						//返回经纬度
						return [parseFloat(parts[0]), parseFloat(parts[1])];
					}
				});

				window.distCluster = distCluster;

				var renderEngine = distCluster.getRender();
				var infoWindow = new SimpleInfoWindow({});

				distCluster.setData([]);

				var placeSearch = new AMap.PlaceSearch({ //构造地点查询类
					pageSize: 2,
					pageIndex: 1,
					extensions: 'all',
					city: "010" //城市
				});

				var resultsCache = {};
				//这里是点击景点的事件
				function listenMarkerClick(m) {

					m.on('click', function(e) {
					    console.log("do")
                        var data = m._data;
                        window.parent.postMessage({
                            data: {
                                id:data.id,
                                address:data.name,
                                needMinutes:data.needMinutes,
                                location:data.location
                            }
                        }, '*');
						infoWindow.setInfoTitle(data.name);
						infoWindow.setInfoBody(data.address);
						infoWindow.open(map, data.location);
					});
				}

				function search(adcode, callback) {

					if (resultsCache[adcode]) {

						setTimeout(function() {
							callback(null, resultsCache[adcode]);
						}, 0);
						return;
					}

					placeSearch.setCity(adcode);
					//在这里判断行政区划更改数据
					placeSearch.search('景点', function(status, result) {
						// console.log('wdaadwaw')
						// console.log(placeSearch)
						// console.log('aaaaa')
						// console.log(adcode)
						// console.log(result)
						if (adcode === 150103) {
                            result.poiList.pois.splice(0,result.poiList.pois.length);
							result.poiList.pois.push({
								"id": "mtx1",
								"name": "海亮广场大酒店",
								"location": [
									111.669808,
									40.815058
								],
								"address": "呼和浩特市回民区中山西路1号",
								"photos": [{
										"title": "",
										"url": "http://localhost:81/img/jpg/cos/hlgc.jpeg",
										"provider": ""
									},
								],
                                "needMinutes":120

							})
                            result.poiList.pois.push({
                                "id": "mtx2",
                                "name": "内蒙古财经大学",
                                "location": [
                                    111.630303,40.856683
                                ],
                                "address": "北二环快速路",
                                "photos": [{
                                    "title": "",
                                    "url": "http://localhost:81/img/jpg/cos/imufe.gif",
                                    "provider": ""
                                },
                                ],
                                "needMinutes":120

                            })
                            result.poiList.pois.push({
                                "id": "mtx3",
                                "name": "南湖公园",
                                "location": [
                                    111.648214,40.746979
                                ],
                                "address": "昭君路",
                                "photos": [{
                                    "title": "",
                                    "url": "http://store.is.autonavi.com/showpic/967efa534663275d46d64ca427800258",
                                    "provider": ""
                                },
                                ],
                                "needMinutes":120

                            })
                            result.poiList.pois.push({
                                "id": "mtx4",
                                "name": "内蒙古饭店",
                                "location": [
                                    111.682944,40.817498
                                ],
                                "address": "乌兰察布西街",
                                "photos": [{
                                    "title": "",
                                    "url": "http://store.is.autonavi.com/showpic/967efa534663275d46d64ca427800258",
                                    "provider": ""
                                },
                                ],
                                "needMinutes":120

                            })
                            result.poiList.pois.push({
                                "id": "mtx5",
                                "name": "敕勒川公园",
                                "location": [
                                    111.766934,40.815163
                                ],
                                "address": "鄂尔多斯东街",
                                "photos": [{
                                    "title": "",
                                    "url": "http://store.is.autonavi.com/showpic/967efa534663275d46d64ca427800258",
                                    "provider": ""
                                },
                                ],
                                "needMinutes":120

                            })
                            result.poiList.pois.push({
                                "id": "mtx6",
                                "name": "草原丝绸之路文化主题公园",
                                "location": [
                                    111.745562,40.81302
                                ],
                                "address": "东二环路",
                                "photos": [{
                                    "title": "",
                                    "url": "http://store.is.autonavi.com/showpic/967efa534663275d46d64ca427800258",
                                    "provider": ""
                                },
                                ],
                                "needMinutes":120

                            })
                            result.poiList.pois.push({
                                "id": "mtx7",
                                "name": "源文化公园",
                                "location": [
                                    111.779179,40.823488
                                ],
                                "address": "科尔沁快速路",
                                "photos": [{
                                    "title": "",
                                    "url": "http://store.is.autonavi.com/showpic/967efa534663275d46d64ca427800258",
                                    "provider": ""
                                },
                                ],
                                "needMinutes":120

                            })
                            result.poiList.pois.push({
                                "id": "mtx8",
                                "name": "太伟运动休闲度假村",
                                "location": [
                                    111.831192,40.947335
                                ],
                                "address": "104省道",
                                "photos": [{
                                    "title": "",
                                    "url": "http://localhost:81/img/jpg/cos/twdzc.jpeg",
                                    "provider": ""
                                },
                                ],
                                "needMinutes":120

                            })
                            result.poiList.pois.push({
                                "id": "mtx9",
                                "name": "明清建筑博览园",
                                "location": [
                                    111.53829,40.770711
                                ],
                                "address": "巴彦塔拉路",
                                "photos": [{
                                    "title": "",
                                    "url": "http://localhost:81/img/jpg/cos/mqjzbly.jpg",
                                    "provider": ""
                                },
                                ],
                                "needMinutes":120

                            })
                            result.poiList.pois.push({
                                "id": "mtx10",
                                "name": "蒙古风情园",
                                "location": [
                                    111.658551,40.711964
                                ],
                                "address": "209国道",
                                "photos": [{
                                    "title": "",
                                    "url": "http://localhost:81/img/jpg/cos/mgfqy.jpeg",
                                    "provider": ""
                                },
                                ],
                                "needMinutes":120

                            })
                            result.poiList.pois.push({
                                "id": "mtx11",
                                "name": "大召无量寺",
                                "location": [
                                    111.653481,40.799338
                                ],
                                "address": "大南街",
                                "photos": [{
                                    "title": "",
                                    "url": "http://localhost:81/img/jpg/cos/dzs.jpeg",
                                    "provider": ""
                                },
                                ],
                                "needMinutes":120

                            })
                            result.poiList.pois.push({
                                "id": "mtx12",
                                "name": "白塔机场",
                                "location": [
                                    111.828029,40.85365
                                ],
                                "address": "机场高速",
                                "photos": [{
                                    "title": "",
                                    "url": "http://localhost:81/img/jpg/cos/btjc.jpeg",
                                    "provider": ""
                                },
                                ],
                                "needMinutes":120

                            })

						}else {
						    status = 'no';
                        }
						if (status !== 'complete') {
							callback(status);
							return;
						}

						var pois = result.poiList.pois,
							results = [];

						for (var i = 0, len = pois.length; i < len; i++) {

							var data = pois[i];

							if (data.photos && data.photos[0]) {

								var node = document.createElement('div');

								node.className = 'poi-img';

								node.style.backgroundImage = 'url(' + data.photos[0].url + '?operate=merge&w=30&h=30)';

								node.title = data.name + '：' + data.address;

								container.append(node);

								var marker = new AMap.Marker({
									topWhenClick: true,
									offset: new AMap.Pixel(-15, 6),
									position: data.location,
									content: node,
									zIndex: 0
								});

								marker._data = data;

								listenMarkerClick(marker);

								results.push(marker);
							}
						}

						results._count = result.poiList.count;

						resultsCache[adcode] = results;

						callback(null, resultsCache[adcode]);
					});
				}

				distCluster.on('clusterMarkerAdd', function(e, marker, record) {

					$(marker.getContent()).find('.amap-ui-district-cluster-marker-body').html('...');

					marker.__adcode = record.adcode;

					search(record.adcode, function(err, foodMarkers) {

						if (err || marker.__adcode !== record.adcode) {
							return;
						}

						record.foodMarkers = foodMarkers;

						if (foodMarkers && foodMarkers.length) {

							for (var i = 0, len = foodMarkers.length; i < len; i++) {

								foodMarkers[i].setMap(map);
							}
						}

						$(marker.getContent()).find('.amap-ui-district-cluster-marker-body').html(foodMarkers
							._count || 0);

					});
				});

				distCluster.on('clusterMarkerRemove', function(e, marker, record) {

					if (record.foodMarkers) {

						var markers = record.foodMarkers;

						for (var i = 0, len = markers.length; i < len; i++) {
							markers[i].setMap(null);
						}

						record.foodMarkers = null;
					}

				});
			}

			//加载相关组件
			AMapUI.load(['ui/geo/DistrictCluster', 'lib/$', 'ui/overlay/SimpleInfoWindow'], function(DistrictCluster, $,
				SimpleInfoWindow) {

				//加载搜索
				AMap.plugin(["AMap.PlaceSearch"], function() {

					//启动页面
					initPage(DistrictCluster, $, SimpleInfoWindow);
				});
			});
			$(".amap-logo").empty();
			$(".amap-copyright").empty();
		</script>
	</body>

</html>
